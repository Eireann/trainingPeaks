<!doctype html>
<html>
    <head>
        <title>Mars Mocha Tests</title>
        <link rel="stylesheet" href="../bower_components/mocha/mocha.css" type="text/css" charset="utf-8" />
    </head>
    <body>
        <div id="mocha"></div>

        <!-- Hide content divs -->
        <div style="display: none;">
            <div id="wrapper">
                <div id="navigation"></div>
                <div id="outerMain"><div role="main" id="main"></div></div>
            </div>
            <div id="info"></div>
        </div>

        <script src="../apiConfig.dev.js"></script>
        <script src="../bower_components/mocha/mocha.js"></script>

        <script src="../bower_components/requirejs/require.js"></script>
        <script>
            requirejs(
            [
                "../app/config"
            ],
            function(commonConfig)
            {

                requirejs.config(commonConfig);
                requirejs.config(
                {
                    baseUrl: '../app',
                    paths: { specs: '../test/specs' }
                });

                requirejs(
                [
                    "underscore",
                    "q",
                    "chai",
                    "sinon",
                    "sinon-chai",
                    "jquery",
                ],
                function(
                    _,
                    Q,
                    chai,
                    sinon,
                    sinonChai,
                    $
                )
                {
                    $.fx.off = true;

                    window.fakeXhr = sinon.useFakeXMLHttpRequest();
                    window.fakeXhr.useFilters = true;
                    window.fakeXhr.addFilter(function(method, url, async, user, pass)
                    {
                        // Attempt to allow require.js ajax requests through (but not CMS refresh events)
                        return !/^http/.test(url);
                    });

                    window.Q = Q;

                    Q.makePromise.prototype.until = function(check, message, timeout)
                    {
                        message = message || "Timed out waiting";
                        timeout = timeout || 2000;
                        function wait()
                        {
                            return check() || Q.delay(0).then(wait);
                        }
                        return Q(wait()).timeout(timeout, message);
                    };

                    mocha.setup("bdd");
                    mocha.timeout(5000);

                    chai.use(sinonChai);

                    window.expect = chai.expect;

                    window.createSpyObj = function(name, methods)
                    {
                        var obj = {};
                        _.each(methods, function(name)
                        {
                            obj[name] = window.sinon.stub();
                        });
                        return obj;
                    };

                    beforeEach(function()
                    {
                        if(window.sinon) window.sinon.restore();
                        window.sinon = sinon.sandbox.create();
                    });

                    // TODO: Ideally we wouldn't stub out setImmediate, but some tests break right now.
                    // Fix the tests so we can use the real setImmediate
                    window.setImmediate = function(cb) { cb(); };
                    define("setImmediate", [], function() { return window.setImmediate; });

                    requirejs(
                    [
                        "Backbone.Marionette.Handlebars",
                        "app",
                        "../test/specs"
                    ],
                    function(bmhbs, theApp, specs)
                    {
                        window.fakeXhr.useFilters = false;
                        mocha.run();
                    });

                });

            });
        </script>
    </body>
</html>
